
<!DOCTYPE html>
<html dir="ltr" lang="en-US">

<head>
	
	<%-include('../partials/head')%>
	<title>Dashboard - GS1</title>

</head>

<body class="stretched">

	<!-- Document Wrapper -->
	<div id="wrapper">

		<%-include('../partials/header') %>

		<!-- Content -->
		<section id="content">
			<div class="content-wrap">

				<div class="container">

					<div class="heading-block text-center">
						<h1 class="tith">Dashboard</h1>
						<span class="stith mt-0">MÉTRICAS DE USUARIO</span>
					</div>

					<div class="line"></div>

					<div class="text-center">
						<div>
							<select class="form-control select" id="select" name="select">
								<option>-- Seleccionar Usuario</option>
								<option>Usuario 01</option>
								<option>Usuario 02</option>
								<option>Usuario 03</option>
							</select>
							<br>
							<button type="button" class="btn btn-secondary ml-1">Buscar</button>
						</div>
					</div>

					<div class="line" style="clear: both;"></div>

					<div class="titu mt-6">Humberto Ramírez Balbuena</div>
					
					<div class="lino"></div>
					
					<div class="container mb-5">
						<div class="row col-mb-50 mb-0">
							<input type="text" class="form-control daterange2" id="data " name="data" value="01/01/2021 1:30 PM - 01/01/2021 2:00 PM">
						</div>
					</div>

					<div class="tsection d-flex align-items-center mb-5"><img class="mr-1" src="images/icon-pc.svg"> <span class="mr-1">actividad</span> <hr class="dot"></div>

					<div class="w-100"></div>

					<div class="tcard mb-5">
						<div class="hcard">Accesos por Día</div>
						<div class="ccard" style="padding-bottom: 0;">
							<div class="mb-5 mx-auto">
								<canvas id="chart-accesos_por_dia" height="50%"></canvas>
							</div>
						</div>
					</div>
					<div class="row col-mb-50 mb-3">
						<div class="col-sm-7 col-lg-1-5 text-center pr-2 pl-2">
							<div class=" bg-orange-lig color-white pt-1 pb-1 radius-top-5">USUARIOS ATENDIDOS</div>
							<div class="bg-blue radius-bottom-5">
								<div class="counter counter-medium color-white pt-4 pb-4" id="usuarios_atendidos">6</div>
							</div>
						</div>
						<div class="col-sm-7 col-lg-1-5 text-center pr-2 pl-2">
							<div class=" bg-orange-lig color-white pt-1 pb-1 radius-top-5">CONSULTAS TOTAL</div>
							<div class="bg-blue radius-bottom-5">
								<div class="counter counter-medium color-white pt-4 pb-4" id="consultas_total">24</div>
							</div>
						</div>
						<div class="col-sm-7 col-lg-1-5 text-center pr-2 pl-2">
							<div class=" bg-orange-lig color-white pt-1 pb-1 radius-top-5">TIEMPO SESIÓN TOTAL </div>
							<div class="bg-blue radius-bottom-5">
								<div class="counter counter-medium color-white pt-4 pb-4" id="tiempo_sesion">7.25 <spam class="fs-6">HRS</spam> </div>
							</div>
						</div>
						<div class="col-sm-7 col-lg-1-5 text-center pr-2 pl-2">
							<div class=" bg-orange-lig color-white pt-1 pb-1 radius-top-5">NÚMERO DE ACCESOS</div>
							<div class="bg-blue radius-bottom-5">
								<div class="counter counter-medium color-white pt-4 pb-4" id="accesos_total">12</div>
							</div>
						</div>
						<div class="col-sm-7 col-lg-1-5 text-center pr-2 pl-2">
							<div class=" bg-orange-lig color-white pt-1 pb-1 radius-top-5">APLICATIVOS CONSULTADOS</div>
							<div class="bg-blue radius-bottom-5">
								<div class="counter counter-medium color-white pt-4 pb-4" id="aplicativos_consultados">12</div>
							</div>
						</div>
					</div>
					<div class="tab-content">
						<div class="tab-pane fade show active" id="home-nav2" role="tabpanel" aria-labelledby="canvas-home-nav2-tab" tabindex="0">
							<div class="table-responsive">
								<table id="datatable1" class="table table-striped table-bordered" cellspacing="0" width="100%">
									<thead>
										<tr>
											<th class="bg-blue color-white">ATENDIDOS</th>
											<th class="bg-blue color-white">FECHA</th>
											<th class="bg-blue color-white">NUM DE CONSULTAS</th>
											<th class="bg-blue color-white">TIEMPO DE SESIÓN</th>
											<th class="bg-blue color-white">APLICATIVOS CONSULTADOS</th>
										</tr>
									</thead>
									
									<tbody>
										<tr>
											<td>Viviana Castellanos Rubio</td>
											<td>14-01-2024</td>
											<td>2</td>
											<td>10 min</td>
											<td>Indicadores</td>
										</tr>
										<tr>
											<td>Fernando Ruiz Legorreta</td>
											<td>14-01-2024</td>
											<td>3</td>
											<td>1:35 hrs</td>
											<td>Vinculación</td>
										</tr>
										<tr>
											<td>Armando Lopez Salgado</td>
											<td>15-01-2024</td>
											<td>1</td>
											<td>11 min</td>
											<td>Eventos</td>
										</tr>
										<tr>
											<td>Mariana Clavijo Torres</td>
											<td>16-01-2024</td>
											<td>4</td>
											<td>14 min</td>
											<td>Reporte Facturación</td>
										</tr>
										<tr>
											<td>Gustavo Ramírez Barboa</td>
											<td>17-01-2024</td>
											<td>11</td>
											<td>1:58 min</td>
											<td>Catálogo Electrónico</td>
										</tr>
									</tbody>
								</table>
							</div>
							<div class="col-12 d-flex mt-4 mb-6">
								<div class="col-auto">									
									<!-- <div class="btn_orange mr-1"><i class="color-white bi-file-earmark-pdf-fill"></i> DOWNLOAD REPORT PDF</div> -->
									<div class="btn_orange mr-1"><i class="color-white bi-file-earmark-excel-fill"></i> DOWNLOAD REPORT XLS</div>
								</div>
							</div>
						</div>
					</div>


					<!-- <div class="tsection d-flex align-items-center my-5"><img class="mr-1" src="images/icon-users.svg"> <span class="mr-1">GENERAL</span> <hr class="dot"></div>
		

					<div class="container">
						<div class="row col-mb-50 mb-0">
							<div class="col-md-8">
								<div class="tcard mb-5">
									<div class="hcard">VOLUMEN DE ATENCIÓN</div>
									<div class="ccard">
										<div class="mb-5 mx-auto" style="max-width: 1150px; height: 250px;">
										<canvas id="chart-volumen_atencion" height="100%"></canvas>

										</div>
									</div>
								</div>
							</div>
							<div class="col-md-4">
								<div class="tcard mb-5">
									<div class="hcard">TOP 10 OPERADORES</div>
									<div class="ccard">
										<div class="mb-5 mx-auto" style="max-width: 1150px; height: 250px;">
											<div class="table-responsive bg_secondary-900">
												<table id="legendTable1" class="" cellspacing="0" width="100%" >
												<thead class="wanna">
													<tr>
													<th></th>
													</tr>
												</thead>
												<tbody>
						
												</tbody>
												</table>
											</div>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div>
					<div class="w-100"></div>
					<div class="container">
						<div class="row col-mb-50 mb-0">
							<div class="col-md-4">
								<div class="tcard mb-5">
									<div class="hcard">VOLUMEN DE CONSULTAS</div>
									<div class="ccard">
										<div class="mb-5 mx-auto" style="max-width: 1150px; height: 250px;">
											<canvas id="chart-volumen_consultas" height="200%"></canvas>
										</div>
									</div>
								</div>
							</div>
							<div class="col-md-4">
								<div class="tcard mb-5">
									<div class="hcard">VOLUMEN DE TIEMPO DE SESIÓN</div>
									<div class="ccard">
										<div class="mb-5 mx-auto" style="max-width: 1150px; height: 250px;">
											<canvas id="chart-volumen_tiempo_sesion" height="200%"></canvas>
										</div>
									</div>
								</div>
							</div>
							<div class="col-md-4">
								<div class="tcard mb-5">
									<div class="hcard">VOLUMEN DE INICIO DE SESIÓN</div>
									<div class="ccard">
										<div class="mb-5 mx-auto" style="max-width: 1150px; height: 250px;">
											<canvas id="chart-volumen_inicio_sesion" height="200%"></canvas>
										</div>
									</div>
								</div>
							</div>
						</div>
					</div> -->


				</div>
			</div>
		</section>
		
		<!-- #content end -->

	</div><!-- #wrapper end -->

	<!-- Go To Top -->
	<div id="gotoTop" class="uil uil-angle-up"></div>

	<!-- JavaScripts -->

	<% libraries.forEach(function(library) { %>

	<script src="<%= library %>"></script> <% }); %> 

<script>
	(function ($) {

		var config_accesos_por_dia = {
			type: 'bar',
			data: {
			labels: ["01-2024","02-2024","03-2024","04-2024", "05-2024", "06-2024", "07-2024",'08-2024','09-2024','10-2024','11-2024','12-2024'],
			datasets: [
				{
				backgroundColor: secondary_700,
				data: [10, 40, 30, 20, 15, 70, 30, 20, 15, 30, 30, 20],
				label: '10.40.73.8'
				},
				{
				backgroundColor: orange_light,
				data: [15, 30, 10, 40, 18, 30, 30, 20, 15, 35, 30, 10],
				label: '10.40.73.8'
				},
				{
				backgroundColor: blue_dark,
				data: [30, 40, 30, 20, 15, 70, 30, 20, 15, 50, 30, 20],
				label: '10.40.73.8'
				},
				{
				backgroundColor: success_200,
				data: [40, 50, 10, 40, 18, 30, 30, 20, 15, 40, 30, 10],
				label: '10.40.73.8'
				},
				{
				backgroundColor: info_200,
				data: [50, 45, 30, 20, 15, 70, 30, 20, 15, 40, 30, 20],
				label: '10.40.73.8'
				},
				{
				backgroundColor: violet_200,
				data: [60, 50, 10, 40, 18, 30, 30, 20, 15, 30, 30, 10],
				label: '10.40.73.8'
				},
				{
				backgroundColor: cherry_200,
				data: [40, 40, 30, 20, 15, 70, 30, 20, 15, 30, 30, 20],
				label: '10.40.73.8'
				},
				{
				backgroundColor: cherry_200,
				data: [30, 50, 10, 40, 18, 30, 30, 20, 15, 60, 30, 10],
				label: '10.40.73.8'
				},
			]
			
			},
			options: {
			responsive: true,
			maintainAspectRatio: true,
			legend:{
				display: false,
			},
			title: { display: false, text: '', position: 'top' },
			scales: {
				yAxes: [{
				ticks: {
					beginAtZero: true,
				}
				}]
			},
			plugins: {
				legend: {
					position: 'bottom',
					display: true,
				},
				title: {
					display: true
				}
			},
			}
		};

        var config_volumen_atencion = {
			type: 'line',
			data: {
				labels: Array.from({ length: 8 }, (_, i) => (i + 1).toString()),
				datasets: [
					{
						borderColor: sky_200,
						data: [100, 40, 10, 60, 170, 80, 90, 100],
						label: 'Alerts',
						showLine: true,
						pointRadius: 1,
						fill: false,
					},
					{
						borderColor: brown_200,
						data: [30, 40, 50, 60, 101, 80, 10, 100],
						label: 'Alerts',
						showLine: true,
						pointRadius: 1 ,
						fill: false,
					},
					{
						borderColor: yellow_200,
						data: [30, 140, 50, 60, 70, 120, 60, 120],
						showLine: true,
						label: 'Alerts',
						pointRadius: 1 ,
						fill: false,
					},
					{
						borderColor: orange_200,
						data: [30, 140, 50, 60, 70, 120, 60, 120],
						showLine: true,
						label: 'Alerts',
						pointRadius: 1 ,
						fill: false,
					},
					{
						borderColor: brick_200,
						data: [30, 140, 50, 60, 70, 120, 60, 120],
						showLine: true,
						label: 'Alerts',
						pointRadius: 1 ,
						fill: false,
					},
					{
						borderColor: cherry_200,
						data: [30, 140, 50, 60, 70, 120, 60, 120],
						showLine: true,
						label: 'Alerts',
						pointRadius: 1 ,
						fill: false,
					},
					{
						borderColor: violet_200,
						data: [30, 140, 50, 60, 70, 120, 60, 120],
						showLine: true,
						label: 'Alerts',
						pointRadius: 1 ,
						fill: false,
					},
					{
						borderColor: success_200,
						data: [30, 140, 50, 60, 70, 120, 60, 120],
						showLine: true,
						label: 'Alerts',
						pointRadius: 1 ,
						fill: false,
					},											
				]
			},
			options: {
				maintainAspectRatio: true,
				responsive: true,
				spanGaps: false,
				elements: {
					line: {
						tension: 0.000001
					},
					point: {
						radius: 6
					}
				},
				scales: {
					yAxes: [{
						stacked: true
					}]
				},
				plugins: {
					filler: {
						propagate: false
					},
					samples_filler_analyser: {
						target: 'chart-analyser'
					},
					datalabels: {
						display: false,
					}
					
				},
				legend:{
					display: true, position: 'bottom',
				},
				// title: { display: true, text: 'Quantity', position: 'left' },
			}
		};

		var config_volumen_consultas = {
			type: 'pie',
			data: {
				datasets: [{
					borderColor: 'transparent',
					data: [5, 10, 20, 15, 25, 10, 15],
					backgroundColor: [
						main_gray_medium, 
						cherry_200,
						orange_200,
						success_200,
						yellow_200,
						blue_dark,
						sky_200,
					],
					label: 'Dataset 1'
				}],
				labels: [
					"Alerts",
					"Alerts",
					"Alerts",
					"Alerts",
					"Alerts",
					"Alerts",
					"Alerts"
				]
			},
			options: {
				maintainAspectRatio: true,
					responsive: true,
					spanGaps: true,
					cutoutPercentage: 0,


				plugins: {
					filler: {
						propagate: false
					},
					samples_filler_analyser: {
						target: ''
					},
					datalabels: {
						display: false,
					},
				},
				legend:{
						display: true, position: 'bottom',
					},
			}
		}
		
		var config_volumen_tiempo_sesion = {
			type: 'pie',
			data: {
				datasets: [{
					borderColor: 'transparent',
					data: [5, 10, 20, 15, 25, 10, 15],
					backgroundColor: [
						main_gray_medium, 
						cherry_200,
						orange_200,
						success_200,
						yellow_200,
						blue_dark,
						sky_200,
					],
					label: 'Dataset 1'
				}],
				labels: [
					"Alerts",
					"Alerts",
					"Alerts",
					"Alerts",
					"Alerts",
					"Alerts",
					"Alerts"
				]
			},
			options: {
				maintainAspectRatio: true,
					responsive: true,
					spanGaps: true,
					cutoutPercentage: 0,


				plugins: {
					filler: {
						propagate: false
					},
					samples_filler_analyser: {
						target: ''
					},
					datalabels: {
						display: false,
					},
				},
				legend:{
						display: true, position: 'bottom',
					},
			}
		}
		
		var config_volumen_inicio_sesion = {
			type: 'pie',
			data: {
				datasets: [{
					borderColor: 'transparent',
					data: [5, 10, 20, 15, 25, 10, 15],
					backgroundColor: [
						main_gray_medium, 
						cherry_200,
						orange_200,
						success_200,
						yellow_200,
						blue_dark,
						sky_200,
					],
					label: 'Dataset 1'
				}],
				labels: [
					"Alerts",
					"Alerts",
					"Alerts",
					"Alerts",
					"Alerts",
					"Alerts",
					"Alerts"
				]
			},
			options: {
				maintainAspectRatio: true,
					responsive: true,
					spanGaps: true,
					cutoutPercentage: 0,


				plugins: {
					filler: {
						propagate: false
					},
					samples_filler_analyser: {
						target: ''
					},
					datalabels: {
						display: false,
					},
				},
				legend:{
						display: true, position: 'bottom',
					},
			}
		}
		
		function initializeDateRangePicker() {
			$(".daterange2").daterangepicker({
				"opens": "center",
				timePicker: true,
				timePickerIncrement: 30,
				locale: {
					format: 'YYYY/MM/DD h:mm A'
				},
				"buttonClasses": "button button-rounded button-mini m-0",
				"applyClass": "button-color",
				"cancelClass": "button-light"
			})
		}
		
		function initializeChartAccesosPorDia() {
          try {
            var ctx_accesos_por_dia = document.getElementById("chart-accesos_por_dia").getContext("2d");
            window.my_accesos_por_dia = new Chart(ctx_accesos_por_dia, config_accesos_por_dia);
            } catch (error) {
            console.error("Error initializing accesos_por_dia chart:", error);
          }
        }
        
		function initializeChartVolumenAtencion() {
			try {
				var ctx_volumen_atencion = document.getElementById("chart-volumen_atencion").getContext("2d");
				window.my_volumen_atencion = new Chart(ctx_volumen_atencion, config_volumen_atencion);

				ctx_volumen_atencion.canvas.onclick = function (event) {
				var elements = window.my_volumen_atencion.getElementsAtEventForMode(event, 'nearest', { intersect: true }, true);
			};
			} catch (error) {
				console.error("Error initializing Volumen Atencion chart:", error);
			}
		}
		
		function dataTableTop10Oeradores() {
					var legendsData = config_volumen_atencion.data.datasets.map(dataset => {
					return {
						label: dataset.label,
						color: dataset.borderColor
					};
					});

					var table = $('#legendTable1').DataTable({searching: false, paging: false, info: false});
					legendsData.forEach(item => {
					var cellContent = `<div class="fs-6"><div style="display: inline-block; width: 40px; height: 15px; background-color: ${item.color};"></div> ${item.label}</div>`;
					table.row.add([cellContent]);
					});
					table.draw();
				}
		
		function initializeChartVolumenConsultas() {
			try {
				var ctx_volumen_consultas = document.getElementById("chart-volumen_consultas").getContext("2d");
				window.my_volumen_consultas = new Chart(ctx_volumen_consultas, config_volumen_consultas);

				ctx_volumen_consultas.canvas.onclick = function (event) {
					var elements = window.my_volumen_consultas.getElementsAtEventForMode(event, 'nearest', { intersect: true }, true);

				};
			} catch (error) {
				console.error("Error initializing Volumen de Consultas chart:", error);
			}
		}
		
		function initializeChartVolumenTiempoSesion() {
			try {
				var ctx_volumen_tiempo_sesion = document.getElementById("chart-volumen_tiempo_sesion").getContext("2d");
				window.my_volumen_tiempo_sesion = new Chart(ctx_volumen_tiempo_sesion, config_volumen_tiempo_sesion);

				ctx_volumen_tiempo_sesion.canvas.onclick = function (event) {
					var elements = window.my_volumen_tiempo_sesion.getElementsAtEventForMode(event, 'nearest', { intersect: true }, true);

				};
			} catch (error) {
				console.error("Error initializing Volumen de Tiempo Sesión chart:", error);
			}
		}
		
		function initializeChartVolumenInicioSesion() {
			try {
				var ctx_volumen_inicio_sesion = document.getElementById("chart-volumen_inicio_sesion").getContext("2d");
				window.my_volumen_inicio_sesion = new Chart(ctx_volumen_inicio_sesion, config_volumen_inicio_sesion);

				ctx_volumen_inicio_sesion.canvas.onclick = function (event) {
					var elements = window.my_volumen_inicio_sesion.getElementsAtEventForMode(event, 'nearest', { intersect: true }, true);

				};
			} catch (error) {
				console.error("Error initializing Volumen de Inicio de Sesión chart:", error);
			}
		}

		const listadoUsuarios = (fecha_inicio=false, fecha_fin=false) => {
		  fetch('/usuarios/lista')
		  .then( (rs) => rs.json() )
		  .then((response) => {
		    const opciones = []
		    if(response.data.length > 0) {
		      opciones.push(`<option value="0">Selecciona un usuario</option>`)
		      for (const op in response.data) {
		        opciones.push(`<option value="${response.data[op]['valor']}">${response.data[op]['nombre']}</option>`)
		      }
		    } else {
		      opciones.push('<option value="0">No se encontraron resultados</option>')
		    }
		    $("#select").html(opciones.join(''))
		    })
		}

		const actualizaAccesosXDia = async (chart, fecha_inicio, fecha_fin) => {
		  fetch(`/actividad/chart/accesos`)
		  .then((rs) => rs.json())
		  .then((response) => {
		    chart.data.labels = response.labels
		    chart.data.datasets = response.data
		    chart.update()
		  })
		}

		const actualizaUsuarios = async () => {
			fetch(`/actividad/count/usuarios`)
			.then((rs) => rs.json())
			.then((response) => {
				$("#usuarios_atendidos").html(response.data)
			})
		}
		
		const actualizaConsultas = async () => {
			fetch(`/actividad/count/consultas_total`)
			.then((rs) => rs.json())
			.then((response) => {
				$("#consultas_total").html(response.data)
			})
		}
		
		const actualizaAccesos = async () => {
			fetch(`/actividad/count/accesos`)
			.then((rs) => rs.json())
			.then((response) => {
				$("#accesos_total").html(response.data)
			})
		}
		
		const actualizaAplicativos = async () => {
			fetch(`/actividad/count/aplicativos`)
			.then((rs) => rs.json())
			.then((response) => {
				$("#aplicativos_consultados").html(response.data)
			})
		}
		
		const actualizaTiempo = async () => {
			fetch(`/actividad/count/tiempo_sesion`)
			.then((rs) => rs.json())
			.then((response) => {
				const horas = response.data > 0 ? response.data / 60 : 0
				$("#tiempo_sesion").html(`${horas} <spam class="fs-6">HRS</spam> `)
			})
		}

		const actualizaTablaUsuarios = async () => {
			fetch(`/actividad/table/resumen`)
			.then((rs) => rs.json())
			.then((response) => {
				console.log(response)
			})
		}
		
		$(document).ready(function () {
			try {
				initializeDateRangePicker();
				initializeChartAccesosPorDia();
				initializeChartVolumenAtencion();
				dataTableTop10Oeradores();
				initializeChartVolumenConsultas();
				initializeChartVolumenTiempoSesion();
				initializeChartVolumenInicioSesion();
				$('#legendTable1 td').css('white-space', 'nowrap');
				jQuery('#datatable1').dataTable({searching: false, paging: true, info: false, lengthMenu: [10, 25, 50], pageLength: 10, ajax: {url: '/actividad/table/resumen'}});
				jQuery('#datatable3').dataTable({searching: true, paging: true, info: true});

			} catch (error) {
				console.error("Error during initialization:", error);
			}

			listadoUsuarios()
			actualizaAccesosXDia(window.my_accesos_por_dia)
			actualizaUsuarios()
			actualizaConsultas()
			actualizaAccesos()
			actualizaAplicativos()
			actualizaTiempo()
			actualizaTablaUsuarios()
		});
	
	})(jQuery);

</script>
</body>
</html>

